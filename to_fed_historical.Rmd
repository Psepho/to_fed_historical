---
title: "History of federal elections in Toronto"
author: "PsephoAnalytics"
date: "September 21, 2015"
output: html_document
---

# Historical patterns

We start by looking at how votes per party have changed over time. Since the polling boundaries and locations change each year, we've standardized the geography of voting by aggregating poll boundaries into census tracts.

```{r,votes_by_year, echo=FALSE,message=FALSE}
library(toVotes)
ct_vote_plot <- function(geo_data, year) {
  library(dplyr)
  geo_data@data$id <- row.names(geo_data@data)
  data <- geo_data@data %>%
    tidyr::gather(party, votes, -id) %>%
    dplyr::group_by(id, party, add = FALSE) %>%
    dplyr::summarize(votes = sum(votes, na.rm = TRUE)) %>%
    dplyr::mutate(prop_votes = votes/sum(votes)) %>%
    dplyr::select(-votes)
  geo_data@data <- dplyr::select(geo_data@data, id)
  geo <- ggplot2::fortify(geo_data, region="id")
  library(ggplot2)
  ggplot(data, aes(map_id = id)) +
    geom_map(aes(fill = cut_interval(prop_votes, length = 0.15)), map = geo) +
    scale_fill_brewer("Proportion of votes", labels=c("Low", rep("", 4), "High"),
                      type = "seq", palette = "YlOrBr") +
    labs(x="", y="", title=paste0(year, " Federal General Election")) +
    theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(), # get rid of x ticks/text
          axis.ticks.x = element_blank(), axis.text.x = element_blank(), # get rid of y ticks/text
          plot.title = element_text(lineheight=.8, face="bold", vjust=1)) + # make title bold and add space +
    expand_limits(x = geo$long, y = geo$lat) +
    facet_wrap(~party, as.table = FALSE)
}
```

```{r, echo=FALSE, cache=TRUE}
ct_vote_plot(fed_votes_2006_geo, 2006)
ct_vote_plot(fed_votes_2008_geo, 2008)
ct_vote_plot(fed_votes_2011_geo, 2011)
```

One pattern that is consistent across all years is the relatively poor showing of any of the "Other" parties, even when considered in the aggregate. Across the years, we can see a remarkable decline in support for the Liberals in the 2011 election, after a relatively strong showing in the 2008 election. NDP support seems to grow from just the downtown in 2006 to a much wider distribution in 2011. Conservative support, conversely, seems to expand in the 2008 election (though not enough to win any seats), to more focused support in specific areas (winning them eight seats in total).

We can take a more direct look at how party support changes over time by plotting the change in the proportion of votes received by each party between 2006 and 2011.

```{r, change_in_votes, echo=FALSE}
library(toVotes)
library(dplyr)
fed_votes_2006_geo@data$id <- row.names(fed_votes_2006_geo@data)
fed_votes_2008_geo@data$id <- row.names(fed_votes_2008_geo@data)
fed_votes_2011_geo@data$id <- row.names(fed_votes_2011_geo@data)
fed_votes_2006_geo@data$year <- 2006
fed_votes_2008_geo@data$year <- 2008
fed_votes_2011_geo@data$year <- 2011
data <- dplyr::bind_rows(fed_votes_2006_geo@data, 
                         fed_votes_2008_geo@data, 
                         fed_votes_2011_geo@data) %>%
  tidyr::gather(party, votes, Other, Conservative, Liberal, NDP) %>% 
  dplyr::filter(year != 2008) %>% 
  dplyr::group_by(year, id, party) %>%
  dplyr::summarize(votes = sum(votes, na.rm = TRUE)) %>% 
  dplyr::mutate(prop_votes = votes/sum(votes, na.rm = TRUE)) %>% 
  dplyr::select(-votes) %>% 
  dplyr::group_by(id, party) %>% 
  dplyr::summarize(change_votes = diff(prop_votes))
fed_votes_2011_geo@data <- dplyr::select(fed_votes_2011_geo@data, id)
geo <- ggplot2::fortify(fed_votes_2011_geo, region="id")
library(ggplot2)
ggplot(data, aes(map_id = id)) +
  geom_map(aes(fill = cut_interval(change_votes, n = 5)), map = geo) +
  scale_fill_brewer("Change in the proportion", labels=c("Decrease", rep("", 3), "Increase"),
                    type = "div", palette = "BrBG") +
  labs(x="", y="", title= "Votes in the 2006 and 2011 Federal General Election") +
  theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(), # get rid of x ticks/text
        axis.ticks.x = element_blank(), axis.text.x = element_blank(), # get rid of y ticks/text
        plot.title = element_text(lineheight=.8, face="bold", vjust=1)) + # make title bold and add space
  expand_limits(x = geo$long, y = geo$lat) +
  facet_wrap(~party, as.table = FALSE)
```

Clearly, the story from 2006 to 2011 is a large, widespread drop in Liberal party support (with an average decline of `r round(abs(mean(filter(data, party == "Liberal", !is.nan(change_votes))$change_votes)),2)*100`% and maximum decline of `r round(abs(min(filter(data, party == "Liberal", !is.nan(change_votes))$change_votes)),2)*100`%). The benefits of this decline were roughly equally shared by the Conservative and NDP parties, but in different locations. The NDP seems to have particularly benefited from the Liberal's decline in the north east.

# Role of incumbents

```{r, incumbents, echo=FALSE}
library(toVotes)
library(dplyr)
# Extract a list of Toronto Federal Districts
data("toFederalVotes")
fed_votes <- toFederalVotes
# Sumarize just the three major parties, the rest are "Other"
major_parties <- c("Conservative", "Liberal", "NDP")
# Standardize the names
levels(fed_votes$party)[c(16, 17, 19)] <- c("NDP", "NDP", "Conservative")
levels(fed_votes$party)[!(levels(fed_votes$party) %in% major_parties)] <- "Other"
droplevels(fed_votes)
# Add in star candidate status
star_status <- readr::read_csv("data/star_status.csv") %>%
  mutate(year = as.factor(year),
         candidate = as.factor(candidate))
candidates <- dplyr::left_join(fed_votes, star_status) %>%
  group_by(year, district, poll, party) %>%
  summarize(star_candidate = max(star_candidate),
            incumbent = max(incumbent),
            n = n()) %>%
  select(-n)
rm(star_status)
# Summarize votes by year, district, and poll
fed_votes <- fed_votes %>%
  mutate(# Clean up polling labels
    # -[letter]|[number] indicate sub-polls and should be merged
    poll = stringr::str_replace(poll, "(\\d{1,3})(-\\d+\\w?|\\D$)", "\\1")
  ) %>%
  group_by(year, district, poll, party) %>%
  summarize(votes = sum(votes)) %>%
  mutate(prop_votes = votes/sum(votes))

data <- dplyr::left_join(candidates, fed_votes)

library(nlme)
library(ape)
candidate_model <- lme(prop_votes ~ party + star_candidate*incumbent, data = data, 
                    random = ~1|year/district, na.action = na.exclude)
summary(candidate_model)

ggplot(data, aes(x = factor(incumbent), y = prop_votes, fill = factor(star_candidate))) + 
  geom_boxplot() +
  scale_x_discrete("Incumbent") +
  scale_y_continuous("Proportion of votes") +
  guides(fill = guide_legend(title = "Star candidate"))

```

Preliminary models show that being either a star candidate or an incumbent can boost your share of the vote by 20%. But, being both doesn't get you an incremental increase.
The effect is roughly equivalent to belonging to a party. So, being a PC/Liberal/NDP member gets you about 20% over unaffiliated. Being a star or an incumbent gets you to 40%.
Interpretation needs to be careful though. PCs don't have any incumbents in the data and NDP don't have any non-incumbent stars.
